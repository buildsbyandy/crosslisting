{% extends "base.html" %}

{% block title %}Sections - Canvas Cross-Listing Tool{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Course Sections</h2>
        {% if term %}
        <p class="text-muted mb-0">Term: <strong>{{ term.name }}</strong> (ID: {{ term.id }})</p>
        {% endif %}
        {% if instructor_info %}
        <p class="text-muted mb-0">Instructor: <strong>{{ instructor_info.name or 'ID: ' + instructor_info.id|string }}</strong></p>
        {% endif %}
        {% if search_term %}
        <p class="text-muted mb-0">Search: <strong>{{ search_term }}</strong></p>
        {% endif %}
    </div>
    <div>
        <a href="{{ url_for('terms') }}" class="btn btn-outline-secondary">‚Üê Back to Terms</a>
        {% if term %}
        <a href="{{ url_for('export', term_id=term.id, instructor=request.args.get('instructor', ''), search_term=request.args.get('search_term', '')) }}"
           class="btn btn-outline-success">Export CSV</a>
        {% endif %}
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <h6 class="alert-heading">Error</h6>
    <p class="mb-0">{{ error }}</p>
</div>
{% endif %}

{% if message %}
<div class="alert alert-info">
    <p class="mb-0">{{ message }}</p>
</div>
{% endif %}

{% if sections %}
<div class="row">
    <div class="col-12">
        <!-- Legend -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="card-title">Section Types:</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="parent-candidate me-2" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                            <span>Parent Candidate (Unpublished)</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="child-candidate me-2" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                            <span>Child Candidate (Published)</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="cross-listed me-2" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                            <span>Already Cross-listed</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="no-candidate me-2" style="width: 20px; height: 20px; border-radius: 3px;"></div>
                            <span>Not Eligible</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sections List -->
        <div class="row">
            {% for section in sections %}
            <div class="col-lg-6 mb-3">
                <div class="card section-card
                    {% if section.parent_candidate %}parent-candidate
                    {% elif section.child_candidate %}child-candidate
                    {% elif section.cross_listed == 'Yes' %}cross-listed
                    {% else %}no-candidate{% endif %}">

                    <div class="card-body">
                        <h6 class="card-title">{{ section.course }}</h6>

                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Published:</small>
                                <span class="badge {% if section.published == 'Yes' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ section.published }}
                                </span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Cross-listed:</small>
                                <span class="badge {% if section.cross_listed == 'Yes' %}bg-warning text-dark{% else %}bg-light text-dark{% endif %}">
                                    {{ section.cross_listed }}
                                </span>
                            </div>
                        </div>

                        {% if section.permission_block %}
                        <div class="alert alert-sm permission-block mt-2">
                            <small>{{ section.permission_block }}</small>
                        </div>
                        {% endif %}

                        <div class="mt-3">
                            <small class="text-muted">Course ID: {{ section.ids.course_id }} | Section ID: {{ section.ids.section_id }}</small>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-3">
                            {% if section.parent_candidate and not section.permission_block %}
                            <button type="button" class="btn btn-sm btn-success"
                                    data-bs-toggle="modal"
                                    data-bs-target="#crosslistModal"
                                    data-parent-course-id="{{ section.ids.course_id }}"
                                    data-parent-name="{{ section.course }}">
                                Use as Parent
                            </button>
                            {% endif %}

                            {% if section.child_candidate %}
                            <button type="button" class="btn btn-sm btn-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#crosslistChildModal"
                                    data-child-section-id="{{ section.ids.section_id }}"
                                    data-child-name="{{ section.course }}">
                                Cross-list This
                            </button>
                            {% endif %}

                            {% if section.undo_allowed %}
                            <button type="button" class="btn btn-sm btn-warning"
                                    data-bs-toggle="modal"
                                    data-bs-target="#uncrosslistModal"
                                    data-section-id="{{ section.ids.section_id }}"
                                    data-section-name="{{ section.course }}">
                                Un-cross-list
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Cross-list Modal (Parent Selection) -->
<div class="modal fade" id="crosslistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cross-list Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('crosslist') }}" method="post">
                <input type="hidden" name="parent_course_id" id="parentCourseId">
                {% if term %}<input type="hidden" name="term_id" value="{{ term.id }}">{% endif %}
                {% if instructor_info %}<input type="hidden" name="instructor_id" value="{{ instructor_info.id }}">{% endif %}

                <div class="modal-body">
                    <p><strong>Parent Course:</strong> <span id="parentCourseName"></span></p>

                    <div class="mb-3">
                        <label for="childSectionSelect" class="form-label">Select Child Section to Cross-list:</label>
                        <select class="form-select" name="child_section_id" id="childSectionSelect" required>
                            <option value="">Choose a published section...</option>
                            {% for section in sections %}
                                {% if section.child_candidate %}
                                <option value="{{ section.ids.section_id }}">{{ section.course }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="alert alert-warning">
                        <small>
                            <strong>Before proceeding:</strong> Ensure the parent course is unpublished and has no student activity.
                            The child course must be published. This action will combine the sections into one course shell.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Cross-list Sections</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cross-list Modal (Child Selection) -->
<div class="modal fade" id="crosslistChildModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cross-list Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('crosslist') }}" method="post">
                <input type="hidden" name="child_section_id" id="childSectionId">
                {% if term %}<input type="hidden" name="term_id" value="{{ term.id }}">{% endif %}
                {% if instructor_info %}<input type="hidden" name="instructor_id" value="{{ instructor_info.id }}">{% endif %}

                <div class="modal-body">
                    <p><strong>Child Section:</strong> <span id="childSectionName"></span></p>

                    <div class="mb-3">
                        <label for="parentCourseSelect" class="form-label">Select Parent Course:</label>
                        <select class="form-select" name="parent_course_id" id="parentCourseSelect" required>
                            <option value="">Choose an unpublished course...</option>
                            {% for section in sections %}
                                {% if section.parent_candidate and not section.permission_block %}
                                <option value="{{ section.ids.course_id }}">{{ section.course }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="alert alert-warning">
                        <small>
                            <strong>Before proceeding:</strong> Ensure the parent course is unpublished and has no student activity.
                            This action will move the selected section into the parent course shell.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Cross-list into Parent</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Un-cross-list Modal -->
<div class="modal fade" id="uncrosslistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Un-cross-list Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('uncrosslist') }}" method="post">
                <input type="hidden" name="section_id" id="uncrosslistSectionId">
                {% if term %}<input type="hidden" name="term_id" value="{{ term.id }}">{% endif %}
                {% if instructor_info %}<input type="hidden" name="instructor_id" value="{{ instructor_info.id }}">{% endif %}

                <div class="modal-body">
                    <p><strong>Section:</strong> <span id="uncrosslistSectionName"></span></p>

                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will remove the section from its current cross-listed course
                        and restore it to its original course. This action cannot be easily undone.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Un-cross-list Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-info">
    <h6 class="alert-heading">No Sections Found</h6>
    <p class="mb-0">No course sections match your search criteria. Try adjusting your search parameters or check that the instructor is active in the selected term.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Handle cross-list modal population
document.addEventListener('DOMContentLoaded', function() {
    // Parent selection modal
    const crosslistModal = document.getElementById('crosslistModal');
    crosslistModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const parentCourseId = button.getAttribute('data-parent-course-id');
        const parentName = button.getAttribute('data-parent-name');

        document.getElementById('parentCourseId').value = parentCourseId;
        document.getElementById('parentCourseName').textContent = parentName;
    });

    // Child selection modal
    const crosslistChildModal = document.getElementById('crosslistChildModal');
    crosslistChildModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const childSectionId = button.getAttribute('data-child-section-id');
        const childName = button.getAttribute('data-child-name');

        document.getElementById('childSectionId').value = childSectionId;
        document.getElementById('childSectionName').textContent = childName;
    });

    // Un-cross-list modal
    const uncrosslistModal = document.getElementById('uncrosslistModal');
    uncrosslistModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const sectionId = button.getAttribute('data-section-id');
        const sectionName = button.getAttribute('data-section-name');

        document.getElementById('uncrosslistSectionId').value = sectionId;
        document.getElementById('uncrosslistSectionName').textContent = sectionName;
    });
});
</script>
{% endblock %}